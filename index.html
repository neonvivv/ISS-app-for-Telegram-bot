<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISS - –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <!-- –®–∞–ø–∫–∞ -->
    <header class="header">
        <img src="src/iss.svg" alt="ISS Logo" class="logo">
    </header>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="main-content">
        <div class="container">
            <!-- –ë–ª–æ–∫–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π -->
            <div class="info-blocks">
                <!-- –ë–ª–æ–∫ —Å –æ—á–∫–∞–º–∏ -->
                <div class="info-block">
                    <div class="block-header">
                        <span class="block-title">Points</span>
                        <img src="src/points.svg" alt="Points" class="block-icon">
                    </div>
                    <div class="block-value">60</div>
                </div>

                <!-- –ë–ª–æ–∫ —Å –ø–æ–≥–æ–¥–æ–π -->
                <div class="info-block weather-block">
                    <div class="block-header">
                        <span class="block-title" id="weatherCity">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <div class="block-value" id="weatherTemp">--¬∞</div>
                    <div class="block-condition" id="weatherCondition">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>

            <!-- –ü—Ä–æ—Ñ–∏–ª—å ISS -->
            <div class="profile-block">
                <div class="profile-header">
                    <div class="profile-name" id="issName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="profile-username" id="issUsername">@–∑–∞–≥—Ä—É–∑–∫–∞</div>
                </div>
                <div class="profile-details">
                    <span class="label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</span> <span id="issRegistrationDate">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
            </div>

            <!-- –ü—Ä–æ—Ñ–∏–ª—å Telegram -->
            <div class="telegram-block">
                <div class="telegram-info">
                    <p><span class="label">–ò–º—è:</span> <span id="telegramName">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
                    <p><span class="label">Username:</span> <span id="telegramUsername">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
                    <p><span class="label">ID –∞–∫–∫–∞—É–Ω—Ç–∞:</span> <span id="telegramId">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="action-buttons">
                <button class="action-btn edit-btn" onclick="editProfile()">
                    ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                </button>
                <button class="action-btn share-btn" onclick="shareProfile()">
                    üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–æ—Ñ–∏–ª–µ–º
                </button>
            </div>
        </div>
    </main>

    <!-- –ù–∏–∂–Ω–∏–π –±–∞—Ä -->
    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="navigateTo('home')">
            <span class="nav-icon">üè†</span>
            <span class="nav-text">–ì–ª–∞–≤–Ω–∞—è</span>
        </button>
        <button class="nav-btn" onclick="navigateTo('points')">
            <span class="nav-icon">üèÜ</span>
            <span class="nav-text">Points</span>
        </button>
        <button class="nav-btn" onclick="navigateTo('settings')">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span class="nav-text">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
        </button>
    </nav>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        let tg = window.Telegram.WebApp;
        tg.ready();

        // –§—É–Ω–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        function navigateTo(page) {
            if (page === 'home') {
                window.location.href = '/';
            } else if (page === 'points') {
                window.location.href = '/points';
            } else if (page === 'settings') {
                window.location.href = '/settings';
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ Telegram Web App API
        let user = tg.initDataUnsafe?.user;

        if (user) {
            // –î–∞–Ω–Ω—ã–µ –∏–∑ Telegram
            const telegramName = user.first_name + (user.last_name ? ' ' + user.last_name : '');
            const telegramUsername = '@' + (user.username || '–Ω–µ —É–∫–∞–∑–∞–Ω');
            const telegramId = user.id;

            document.getElementById('telegramName').textContent = telegramName;
            document.getElementById('telegramUsername').textContent = telegramUsername;
            document.getElementById('telegramId').textContent = telegramId;

            // –ü–æ–ª—É—á–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ API
            fetch(`/api/user-profile?user_id=${user.id}`)
                .then(response => {
                    console.log('API Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('API Response data:', data);
                    if (!data.error) {
                        // –î–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è ISS
                        document.getElementById('issName').textContent = data.name;
                        document.getElementById('issUsername').textContent = '@' + (data.username || '–Ω–µ —É–∫–∞–∑–∞–Ω');
                        document.getElementById('issCity').textContent = data.city;
                        document.getElementById('issRegistrationDate').textContent = new Date(data.registration_date).toLocaleDateString('ru-RU');
                    } else {
                        console.log('API Error:', data.error);
                        // –û—Å—Ç–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        document.getElementById('issName').textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                        document.getElementById('issUsername').textContent = '@–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
                        document.getElementById('issRegistrationDate').textContent = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                    }
                })
                .catch(error => {
                    console.log('API request failed:', error);
                    // –û—Å—Ç–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    document.getElementById('issName').textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                    document.getElementById('issUsername').textContent = '@–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
                    document.getElementById('issRegistrationDate').textContent = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                });

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ
            fetch('/api/weather')
                .then(response => {
                    console.log('Weather API Response status:', response.status);
                    return response.json();
                })
                .then(weatherData => {
                    console.log('Weather API Response data:', weatherData);
                    if (!weatherData.error) {
                        document.getElementById('weatherCity').textContent = weatherData.city;
                        document.getElementById('weatherTemp').textContent = weatherData.temperature + '¬∞';
                        document.getElementById('weatherCondition').textContent = weatherData.condition;
                    } else {
                        console.log('Weather API Error:', weatherData.error);
                        // –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        document.getElementById('weatherCity').textContent = '–ú–æ—Å–∫–≤–∞';
                        document.getElementById('weatherTemp').textContent = '12¬∞';
                        document.getElementById('weatherCondition').textContent = '–°–æ–ª–Ω–µ—á–Ω–æ';
                    }
                })
                .catch(error => {
                    console.log('Weather API request failed:', error);
                    // –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    document.getElementById('weatherCity').textContent = '–ú–æ—Å–∫–≤–∞';
                    document.getElementById('weatherTemp').textContent = '12¬∞';
                    document.getElementById('weatherCondition').textContent = '–°–æ–ª–Ω–µ—á–Ω–æ';
                });
        } else {
            document.getElementById('telegramName').textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
            document.getElementById('telegramUsername').textContent = '‚Äî';
            document.getElementById('issName').textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            document.getElementById('issUsername').textContent = '@–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–æ—Ñ–∏–ª–µ–º
        function shareProfile() {
            // –ü–æ–ª—É—á–∞–µ–º username –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è ISS
            const username = document.getElementById('issUsername').textContent.replace('@', '');
            if (username && username !== '–∑–∞–≥—Ä—É–∑–∫–∞' && username !== '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω') {
                const botUsername = "Intelligence_playground_bot";
                const profileLink = `https://t.me/${botUsername}?start=profile_${username}`;

                if (tg.initDataUnsafe?.user) {
                    tg.showPopup({
                        title: '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–æ—Ñ–∏–ª–µ–º',
                        message: '–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å –≤ ISS:',
                        buttons: [
                            {id: 'share', type: 'default', text: '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è'},
                            {id: 'cancel', type: 'cancel'}
                        ]
                    }, function(buttonId) {
                        if (buttonId === 'share') {
                            tg.shareUrl(profileLink);
                        }
                    });
                } else {
                    tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }
            } else {
                tg.showAlert('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ username –≤ –ø—Ä–æ—Ñ–∏–ª–µ, —á—Ç–æ–±—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –∏–º');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        function editProfile() {
            tg.showAlert('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –±–æ—Ç–µ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É /profile');
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–º—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç Telegram
        if (tg.colorScheme === 'dark') {
            document.body.classList.add('dark-theme');
        }
    </script>
</body>
</html>