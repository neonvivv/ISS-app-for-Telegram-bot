<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISS - –ù–∞—Å—Ç—Ä–æ–π–∫–∏</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <!-- –®–∞–ø–∫–∞ -->
    <header class="header">
        <img src="src/iss.svg" alt="ISS Logo" class="logo">
    </header>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="main-content">
        <div class="container">
            <div class="settings-section">
                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ -->
                <div class="setting-group">
                    <h3>üéØ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞</h3>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">–°—Ç—Ä–∏–º–∏–Ω–≥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞</div>
                            <div class="setting-description">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –ø–æ –º–µ—Ä–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–ª–∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="streamingToggle" onchange="toggleStreaming()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
                <div class="setting-group">
                    <h3>üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</div>
                            <div class="setting-description">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö –∏ —Ñ—É–Ω–∫—Ü–∏—è—Ö</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="updatesToggle" onchange="toggleNotification('updates')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</div>
                            <div class="setting-description">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="changesToggle" onchange="toggleNotification('changes')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">–ü—Ä–æ–º–æ-—Å–æ–æ–±—â–µ–Ω–∏—è</div>
                            <div class="setting-description">–†–µ–∫–ª–∞–º–Ω—ã–µ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="promoToggle" onchange="toggleNotification('promo')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- –ù–∏–∂–Ω–∏–π –±–∞—Ä -->
    <nav class="bottom-nav">
        <button class="nav-btn" onclick="navigateTo('home')">
            <span class="nav-icon">üè†</span>
            <span class="nav-text">–ì–ª–∞–≤–Ω–∞—è</span>
        </button>
        <button class="nav-btn" onclick="navigateTo('points')">
            <span class="nav-icon">üèÜ</span>
            <span class="nav-text">Points</span>
        </button>
        <button class="nav-btn active" onclick="navigateTo('settings')">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span class="nav-text">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
        </button>
    </nav>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        let tg = window.Telegram.WebApp;
        tg.ready();

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ Telegram Web App API
        let user = tg.initDataUnsafe?.user;

        // –§—É–Ω–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        function navigateTo(page) {
            if (page === 'home') {
                window.location.href = '/';
            } else if (page === 'points') {
                window.location.href = '/points';
            } else if (page === 'settings') {
                window.location.href = '/settings';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function loadSettings() {
            if (user) {
                fetch(`/api/user-settings?user_id=${user.id}`)
                    .then(response => response.json())
                    .then(settings => {
                        if (!settings.error) {
                            document.getElementById('streamingToggle').checked = settings.streaming_enabled !== false;
                            document.getElementById('updatesToggle').checked = settings.updates_enabled !== false;
                            document.getElementById('changesToggle').checked = settings.changes_enabled !== false;
                            document.getElementById('promoToggle').checked = settings.promo_enabled !== false;
                        }
                    })
                    .catch(error => {
                        console.log('Settings load failed:', error);
                    });
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞
        function toggleStreaming() {
            const enabled = document.getElementById('streamingToggle').checked;
            updateSetting('streaming_enabled', enabled);
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function toggleNotification(type) {
            const enabled = document.getElementById(type + 'Toggle').checked;
            updateSetting(type + '_enabled', enabled);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        function updateSetting(settingKey, value) {
            if (user) {
                fetch('/api/user-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: user.id,
                        setting: settingKey,
                        value: value
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.error) {
                        console.log('Setting update failed:', result.error);
                        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —á–µ–∫–±–æ–∫—Å –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                        if (settingKey === 'streaming_enabled') {
                            document.getElementById('streamingToggle').checked = !value;
                        } else {
                            const type = settingKey.replace('_enabled', '');
                            document.getElementById(type + 'Toggle').checked = !value;
                        }
                    }
                })
                .catch(error => {
                    console.log('Setting update error:', error);
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —á–µ–∫–±–æ–∫—Å –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    if (settingKey === 'streaming_enabled') {
                        document.getElementById('streamingToggle').checked = !value;
                    } else {
                        const type = settingKey.replace('_enabled', '');
                        document.getElementById(type + 'Toggle').checked = !value;
                    }
                });
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadSettings();

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–º—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç Telegram
        if (tg.colorScheme === 'dark') {
            document.body.classList.add('dark-theme');
        }
    </script>
</body>
</html>